---
title: "Baltimore Criminal Case Addresses"
output: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
# Setup Knitr to display code output by default but suppress messages
knitr::opts_chunk$set(echo = TRUE, paged.print = TRUE, message = FALSE, warning = FALSE, rows.print=10)
```

## Connect to the Database

```{r results = 'hide'}

library(tidyverse) # For tidy data
library(dplyr)
library(here) # For consistent file pathing
library(odbc) # For connecting to the database
library(RMySQL) # For connecting to the database
library(stringdist) # Dependancy for refinr; do not install from binary
library(refinr) # For address standardization

# Presentation
library(knitr)
library(kableExtra)

# Establish connection with database
con <- dbConnect(MySQL(),
              user="smussenden",
              password="dUM1L0FTqnCdsbpJ",
              dbname='criminal_circuit_baltimore_city',
              host='clue.ctdfdskvfoc5.us-east-1.rds.amazonaws.com')

con2 <- dbConnect(MySQL(),
              user="smussenden",
              password="dUM1L0FTqnCdsbpJ",
              dbname='civil_circuit_regular',
              host='clue.ctdfdskvfoc5.us-east-1.rds.amazonaws.com')

```

```{r results = 'hide'}

# Explore tables and variables available
dbListTables(con2)
dbListFields(con, "charge_and_disposition_information")
dbListFields(con2, "related_person")

## Store useful tables

# Criminal
crim_case_info <- dbReadTable(con, "case_information")
crim_defendant_info<- dbReadTable(con, "defendant_information")
crim_charge_and_disposition_info <- dbReadTable(con, "charge_and_disposition_information")

# Civil
civil_case_info <- dbReadTable(con2, "case_information") %>%
  filter(str_detect(County, "Baltimore City")) %>%
  # Split & filter by years
  separate(FilingDate, into = c("filing_year", "filing_month", "filing_day"), sep = "-", remove = F) %>%
  filter(filing_year >= 2014)

civil_defendant_info <- dbReadTable(con2, "related_person") %>%
  filter(City == "Baltimore")

# glimpse(crim_charge_and_disposition_info)

```

```{r results='hide'}
# Disconnect from the database
dbDisconnect(con)
dbDisconnect(con2)
rm(con, con2)
```


## Criminal Case Exploration

### NAs

** Conclusions:** 

* An insignificant number of **Addresses** are marked NA. 
* A large percentage of **DefendantName** and **ALIAS** are NA, but only 18% overlap.
* In no cases is **CaseNumber** marked NA

** Frequency Breakdown:**

* **DefendantName**: 410,510 out of 835437, 49%
* **ALIAS**: 571,256, 63%
* **Both**: DefendantName _and_ ALIAS: 146,329, 18%
* **Address**: 14
* **CaseNumber**: 0

```{r}
# Check NAs
crim_defendant_info %>%
  # filter(is.na(DefendantName)) # 410,510 out of 835437, 49%
  # filter(is.na(ALIAS)) # 571,256, 63%
  # filter(is.na(ALIAS) & is.na(DefendantName)) # 146,329, 18%
  # filter(is.na(Address)) # 14
  filter(is.na(CaseNumber)) # 0
```

#### Explore instances when both DefendantName and ALIAS are NA

**Conclusions:**

* Most cases with both **both name and alias as NA** have at least two rows, indicating the **name is expressed in another row**. Only 80 of 146,367 do not fit this pattern. 
  * All 80 follow the case number pattern of **"24Qxxxxxxxx"**. Many, but not all, of those are pre-2000. 
  * I'm satisfied, based on the low frequency, we can ignore the 80 "24Q" cases that are missing DefendantName and ALIAS with no second case number appearance unless we encounter a specific reason to learn more about them.

```{r}

### Verify that all cases with both name and alias as NA have multiple entries of the case number

# Store case numbers that have a both_na value
wk_1 <- crim_defendant_info %>%
  filter(is.na(DefendantName) & is.na(ALIAS)) %>%
  select(CaseNumber) %>%
  arrange(desc(CaseNumber))

# Do a join on the full table to find the cases numbers that correlate to both_na
crim_defendant_info %>%
  # Filter the full table for the CaseNumbers that have both_na
  semi_join(wk_1) %>%
  # Group CaseNumbers to count how many times they appear
  group_by(CaseNumber) %>%
  select(CaseNumber) %>%
  summarize(n = n()) %>%
  arrange(n) %>%
  # Now group the counts to count how many are at each value
  group_by(n) %>%
  select(n) %>%
  summarize(count_ns = n())

# Explore cases showing single entries for both_na circumstance
# All follow pattern of beginning with 24Q
crim_defendant_info %>%
  # Filter the full table for the CaseNumbers that have both_na
  semi_join(wk_1) %>%
  # Group CaseNumbers to count how many times they appear
  group_by(CaseNumber) %>%
  select(CaseNumber) %>%
  summarize(n = n()) %>%
  arrange(n)

# Check whether all cases following 24Q pattern are pre-2000 cases.
# Conclusion: 69 follow this pattern, but 21 do not. Roughly 3/4 do.
crim_case_info %>%
  # Filter for cases starting with 24Q
  filter(str_detect(CaseNumber, "^24Q")) %>%
  # Split out the years and convert them to numeric
  separate(FilingDate, into = c("file_year", "file_month", "file_day"), sep = "-") %>%
  separate(StatusDate, into = c("stat_year", "stat_month", "stat_day"), sep = "-") %>%
  mutate_at("file_year", as.numeric) %>%
  mutate_at("stat_year", as.numeric) %>%
  # When either year is pre-2000, make flag column true 
  mutate(flag = case_when(
    file_year < 2000 | stat_year < 2000 ~ T,
    T ~ F
  )) %>%
  # Group and count T/F
  group_by(flag) %>%
  select(flag) %>%
  summarize(n = n())


### Present example cases

# Example case showing multiple entries for a single case number
crim_defendant_info %>%
  filter(CaseNumber == 819295003)
crim_case_info %>%
  filter(CaseNumber == 819295003)


# Example of case showing single entry for a both_na circumstance
crim_defendant_info %>%
  filter(CaseNumber == "24Q99039632")
crim_case_info %>%
  filter(CaseNumber == "24Q99039632")

# Clean up workspace
rm(wk, wk_1, wk_2)

```

### Addresses

Note some cases have multiple addresses that may or may not be linked to a DefendantName or an ALIAS. The CaseNumber is the thing that links the multiple addresses to the defendant.

#### Counts of interesting values

```{r}

# Group addresses and check counts
crim_defendant_info %>%
  group_by(Address) %>%
  select(Address) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  mutate(perc = (n / sum(n)) * 100)

```

* **"DEF"**: 258761, 30%
* **"UNKNOWN"**:	408,	0.05%
* **"unk|fixed|given|homeless"** minus "dun|bun|airy": 1194
* **WCI**: 21
* **NA**: 14

```{r}

# Count values we expect to be homeless
crim_defendant_info %>%
  mutate_if(is.character, tolower) %>%
  filter(str_detect(Address, "unk|fixed|given|homeless")) %>%
  filter(!str_detect(Address, "dun|bun|airy")) %>%
  # summarize(n=n()) # Get total count
  group_by(Address) %>%
  summarize(n = n()) %>%
  arrange(desc(n))

```

#### Explore Address == DEF

* **"DEF"**: 258,761, 30%
* **"DEF"** _and_ **DefendantName is NA**: 258,761, SAME
* **"DEF"** _and_ **ALIAS is NA**: 27

All DEF have no DefendantName. An insignificant number have no ALIAS, either.

DEF is used for names that are ALIASes. It is a reference to "defendant," pointing the reader to the address listed under the defendant's primary name. This can be found by filtering crim_defendant_info by the CaseNumber. (Determined with a combination of queries and talking to a clerk.)

It should be safe to drop all `Address == "DEF"`.

```{r}

### Further code supporting the above

# Compare DEF to DefendantName and ALIAS
crim_defendant_info %>%
  mutate_if(is.character, tolower) %>%
  # filter((Address == "def") & is.na(DefendantName))
  filter((Address == "def") & is.na(ALIAS))

# View DEF rows
crim_defendant_info %>%
  mutate_if(is.character, tolower) %>%
  filter(Address == "def")

# Check the case number in crim_case_info
crim_case_info %>%
  filter(CaseNumber == 200004046)

# Check the case number in crim_defendant_info
crim_defendant_info %>%
  filter(CaseNumber == 200004046)

```

#### Addresses with 50 or more counts

**Variations to Note**

* St., street, st, or no designation (Avenue, Road, Street, etc. follow similar patterns)
* E., E, East or no direction (East, West, North, South)
* Check for common misspellings, such as Forrrest, Forrest, Forest
* P.O. Boxes can also be PO, P O or be missing a single period, and may or may not have additional numbers or location info attached. e.g. "jci - p.o. box 534" = "P O Box 534" = "m h c annex box 534" = "p.o. box 534 id# 340586"

```{r results='hide', echo=F}

# Store addresses and info
addresses_high_count <- tribble(
  ~Address, ~Name, ~Type, ~Note,
  "401 East EAGER ST", "Baltimore City Detention Center", "prison", "",
  "620 FALLSWAY", "Weinberg Housing and Resource Center", "shelter", "",
  "1029 East BALTIMORE St", "Helping Up Missions", "rehab center", "",
  "3643 WOODLAND AVE", "Gaudenzia Inc Weinberg Center", "rehab center", "",  
  "4 North CENTRAL AVE", "Baltimore Rescue Mission", "shelter", "",
  "210 GUILFORD AVE", "Baltimore City Health Department", "gov office", "",
  "954 FORREST ST", "Metropolitan Transition Center", "prison", "min sec",
  "18701 ROXBURY RD", "Roxbury Correctional Institution", "prison", "med sec",
  "300 East MADISON ST", "Baltimore Central Booking and Intake Center", "gov office", "corrections",
  "725 FALLSWAY", "Our Daily Bread Employment Center", "ngo office", "",
  "P.O. BOX 549", "Jessup Correctional Institution", "prison", "med sec",
  "P.O. BOX 534", "Jessup Correctional Institution", "prison", "med sec",
  "140 West WEST ST", "The Baltimore Station", "rehab center", "veterans",
  "111 PARK AVE", "Healthcare for the Homeless", " ngo office", "",
  "4217 SEIDEL AVE", "home", "townhouse", "",
  "1005 STERRETT ST", "home", "townhouse", "",
  "1236 SCOTT ST", "home", "townhouse", "",
  "9136 LIBERTY RD", "home", "house", "",
  "454 East FEDERAL ST", "home", "townhouse", "",
  "241 MILTON AVE", "home", "townhouse", "",
  "3214 RAVENWOOD AVE", "home", "house", "",
  "1125 BATTERY AVE", "home", "townhouse", "",
  "1804 POPLAR GROVE ST", "home", "townhouse", "",
  "1808 WILHELM ST", "home", "townhouse", "",
  "121 South PAYSON ST", "home", "townhouse", "",
  "142 South KOSSUTH ST", "home", "condo", "",
  "2516 BROOKFIELD AVE", "home", "house", "",
  "5433 BELLE VISTA AVE", "home", "townhouse", "",
  "1653 RUXTON AVE", "home", "house", "",
  "1618 POPLAR GROVE ST", "home", "house", "",
  "5606 PARK HEIGHTS AVE", "home", "townhouse", "",
  "P.O. BOX 47086", "home", "Demitrius Jones or Kevin Slade", "",
  "P.O. BOX 38308", "home", "unknown person", "",
  "1204 RIGGS AVE", "home", "condo", "",
  "2213 West LEXINGTON ST", "home", "house", "",
  "720 DR BENJAMIN QUARLES PLACE", "home", "condo", "",
  "1317 WEBSTER ST", "home", "townhouse", "",
  "2606 OSWEGO AVE", "home", "house", "",
  "5002 BARTON AVE", "home", "townhouse", ""
) %>%
  # Standardize to lowercase
  mutate_if(is.character, tolower)
```

```{r rows.print=20, echo=F}
# Display
addresses_high_count %>%
  kable(caption = "Addresses appearing 50 or more times") %>%
  kable_styling("striped", fixed_thead = T) %>%
  scroll_box(width = "100%", height = "500px")

```

#### Properly group and count all variations of the above

```{r}

# Clean up Address column
crim_defendant_info_clean <- crim_defendant_info %>%
  # Standardize to lowercase
  mutate_if(is.character, tolower) %>%
  # Standardize cardinal directions
  mutate(Address = str_replace_all(Address, "\\se(\\s|\\.)", " east ")) %>% # "e" or "e." becomes "east"
  mutate(Address = str_replace_all(Address, "\\sw(\\s|\\.)", " west ")) %>%
  mutate(Address = str_replace_all(Address, "\\sn(\\s|\\.)", " north ")) %>%
  mutate(Address = str_replace_all(Address, "\\ss(\\s|\\.)", " south ")) %>%
  # Standardize street type suffixes
  mutate(Address = str_replace_all(Address, "\\s(street|st\\.)(\\s|$)", " st")) %>% # "street" or "st." becomes "st"
  mutate(Address = str_replace_all(Address, "\\s(avenue|ave\\.)(\\s|$)", " ave ")) %>%
  mutate(Address = str_replace_all(Address, "\\s(road|rd\\.)(\\s|$)", " rd ")) %>%
  mutate(Address = str_replace_all(Address, "\\s(highway|hwy\\.)(\\s|$)", " hwy ")) %>%
  mutate(Address = str_replace_all(Address, "\\s(boulevard|blvd\\.)(\\s|$)", " bldv ")) %>%
  # Standardize PO boxes. 
  mutate(Address = str_replace_all(Address, "(\\s|^|/)((po)|(p\\so)|(p\\.o)|(po\\.))((\\s(box))|(\\s(bx)))", " p.o. box")) %>% # "po | p o | p.o | po." followed by "box" or "bx" become "p.o. box"
  mutate(Address = str_replace_all(Address, "\\s(box)-", " box ")) %>% # Removes hyphens from PO boxes, e.g. "box-xxxx" becomes "box xxxx"
  mutate(Address = str_replace_all(Address, "id#\\s\\d+", " ")) %>% # Remove ID#s from addresses, such as from prison P.O. boxes
  # Remove any white space inadvertantly added
  mutate(Address = str_trim(Address)) %>%
  # Replace case-by-case
  mutate(Address = str_replace_all(Address, "po boc 549 mci-j", "p.o. box 549 mci-j")) %>%
  # Convert addresses to institution locations
  mutate(Institution = case_when(
    # Each case below was manually checked and adjusted for variations in source data
    str_detect(Address, "(box)\\s((549)|(534))") ~ "jessup correctional institution",
    str_detect(Address, "(401 east eager)|(baltimore city detention center)") ~ "baltimore city detention center",
    str_detect(Address, "620 fallsway") ~ "weinberg housing and resource center",
    str_detect(Address, "(1029 east baltimore)|((?<!p)((help)|(helping) (us|up|out) mission))") ~ "helping up mission", # not preceded by "p" to avoid falsely matching "phelps"
    str_detect(Address, "(3643 woodland)|(gaudenzia inc)|(c/o gaudenzia)") ~ "gaudenzia inc weinberg center",
    str_detect(Address, "^4 north central") ~ "baltimore rescue mission",
    str_detect(Address, "210 guilford") ~ "baltimore city health department",
    str_detect(Address, "954 fo(r|rr)est") ~ "metropolitan transition center",
    str_detect(Address, "((18\\d+ (ro(x|xs)bu(r|rr)(y|g)))|(roxbur(y|g) corr))|(roxbur$)|(roxburury)") ~ "roxbury correctional institution",
    str_detect(Address, "(300 east madison)|(central booking intake)") ~ "baltimore central booking and intake center",
    str_detect(Address, "(725 fallsway)|(bread)") ~ "our daily bread employment center",
    str_detect(Address, "^140 west west") ~ "the baltimore station veterans rehab",
    str_detect(Address, "(wci)|(13800 mcmullen)|(western correctional)") ~ "western correctional institution",
    str_detect(Address, "(^111 park)|(healthcare)") ~ "health care for the homeless",
    str_detect(Address, "(?<!((for )|(the )))(homeless)") ~ "marked \"homeless\"", # not preceded by "for" or "the" to avoid labeling "health care (for / for the) homeless"
    T ~ NA_character_
  )) %>%
  # Add column to designate type of institution
  mutate(Institution_Type = case_when(
    str_detect(Institution, "(detention)|(correction)|(booking)") ~ "corrections",
    !is.na(Institution) ~ "homeless resource (unspecified)",
    T ~ NA_character_
  ))


```


```{r results='hide', echo=F}

# Store addresses and info for Baltimore City homelessness resources
# From https://human-services.baltimorecity.gov/sites/default/files/Baltimore%20Street%20Outreach%20Card%20-%20english.pdf
homeless_resources <- tribble(
  ~Institution, ~Address, ~Institution_Type,
  "American Rescue Workers", "11 West Clement St", "Emergency Shelter",
  "Baltimore Rescue Mission", "4 North Central Ave", "Emergency Shelter",
  "Baltimore Outreach Services", "701 South Charles St", "Emergency Shelter",
  "Helping Up Mission", "1029 East Baltimore St", "Emergency Shelter",
  "Karis Home", "1228 East Baltimore St", "Emergency Shelter",
  "Loving Arms", "3313 Oakfield Ave", "Emergency Shelter",
  "MCVET-Veterans", "301 North High St", "Emergency Shelter",
  "Project PLASE - Men", " 201 East North Ave", "Emergency Shelter",
  "Project PLASE - Women", "139 East North Ave", "Emergency Shelter",
  "Salvation Army/Booth House", "1114 North Calvert St", "Emergency Shelter",
  "Sarah’s Hope Shelter", "1114 Mount St", "Emergency Shelter",
  "Weinberg Housing and Resource Center", "620 Fallsway", "Emergency Shelter",
  "Baltimore Medical System", "900 South Caton Ave", "Health Care", 
  "Baltimore Medical System", "3120 Erdman Ave", "Health Care", 
  "Baltimore Medical System", "3700 Fleet St", "Health Care", 
  "Chase Brexton Health Services", "1111 North Charles St", "Health Care", 
  "Druid Dental, Family Planning, and STD Clinic", "1515 West North Ave", "Health Care", 
  "Eastern Dental, Family Planning, STD, and Tuberculosis Clinic", "620 North Caroline St", "Health Care", 
  "Health Care for the Homeless", "421 Fallsway", "Health Care", 
  "Park West Health System", "4120 Patterson Ave", "Health Care", 
  "Park West Health System", "4151 Park Heights Ave", "Health Care", 
  "Park West Health System", "3319 West Belvedere Ave", "Health Care", 
  "Park West Health System", "4601 Liberty Heights Ave", "Health Care", 
  "Total Health Care Men’s Health Center", "1515 West North Ave", "Health Care", 
  "MCVET-Veterans", "301 North High St", "Food Bank",
  "Rose Street Basic Center", "2525 East Madison St", "Food Bank",
  "St. Vincent de Paul of Baltimore Career Center", "3445 Park Heights Ave", "Food Bank",
  "HealthCare Access Maryland", "201 East Baltimore St", "Food Bank",
  "Beans and Bread", "402 South Bond St", "Food Bank",
  "Franciscan Center", "101 West 23rd St", "Food Bank",
  "H.O.P.E.", "2828 Loch Raven Rd", "Food Bank",
  "Manna House", "435 East 25th St", "Food Bank",
  "My Sister’s Place Women’s Center", "17 West Franklin St", "Food Bank",
  "Our Daily Bread Employment Center", "725 Fallsway", "Food Bank",
  "Paul’s Place", "1118 Ward St", "Food Bank",
  "People Encouraging People", "4201 Primrose Ave", "Food Bank",
  "Power Inside", "325 East 25th St", "Food Bank",
  "Bon Secours Women’s Resource Center", "10 North Pulaski St", "Food Bank",
  "YES Drop-in Center for 14-25yr olds & their children", "2315 North Charles St", "Food Bank",
  "Homeless Persons Representation Project", "201 North Charles St", "Food Bank",
  "The Baltimore Station - Veterans", "140 West West St", "Food Bank",
  "Feedmore", "421 Fallsway", "Food Bank"
) %>%
  # Standardize to lowercase
  mutate_if(is.character, tolower) %>%
  arrange(Address)

```

```{r}

# Merge the clean defendant list with the list of homeless facilities
crim_defendant_info_clean_2 <-
  crim_defendant_info_clean %>%
  left_join(homeless_resources %>% 
              # Keep only unique addresses to prevent muliple match duplication in the join
              distinct(Address, .keep_all = TRUE), 
            by = c("Address")
            ) %>%
  # Transpose Institution_Type values from homeless resources list
  mutate(Institution = ifelse(!is.na(Institution.y), Institution.y, Institution.x)) %>%
  mutate(Institution_Type = ifelse(!is.na(Institution_Type.y), Institution_Type.y, Institution_Type.x)) %>%
  # Drop redundant col and rename remaining
  select(-matches("\\.x$|\\.y$")) %>%
  mutate(Is_Homeless = ifelse((!is.na(Institution_Type) & Institution_Type != "corrections"), T, F)) %>%
  filter(!is.na(CaseNumber)) %>%
  arrange(Institution) 
  # group_by(Institution, Institution_Type) %>%
  # select(Institution, Institution_Type, Address) %>%
  # summarize(n = n())

# View unique CaseNumbers only 
# 425,354 distinct (matches crim_case_info table's variable count)
crim_defendant_info_clean_2 %>% 
  distinct(CaseNumber)

# Count homeless
# 2,652 distinct case numbers
crim_defendant_info_clean_2 %>%
  filter(Is_Homeless) %>%
  distinct(CaseNumber, .keep_all = TRUE)

# View counts at each institution
crim_defendant_info_clean_2 %>%
  filter(Is_Homeless == T ) %>%
  distinct(CaseNumber, .keep_all = TRUE) %>%
  group_by(Institution) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  # summarize(sum(n)) # confirm count
  # Display prettily
  kable(caption = "Frequency of known homelessness organizations") %>%
  kable_styling("striped", fixed_thead = T) %>%
  scroll_box(width = "100%", height = "500px")
  

crim_defendant_info_clean_2 %>%
  ilter(Is_Homeless == T ) %>%
  distinct(CaseNumber, .keep_all = TRUE) %>%
  group_by(Institution_Type) %>%
  summarize(n = n())

# Clean up workspace
# rm(list=setdiff(ls(), c("con", "crim_case_info", "crim_defendant_info_clean_2")))
rm(addresses_high_count, crim_defendant_info, crim_defendant_info_clean)

# Store the updated defendant info
# crim_defendant_info_clean_2 %>% write_csv(here("data", "input-data", "large-files", "criminal_baltimore_city_defendant_info.csv"))

```



```{r}

# Make a vector of all casenums that appear in the crim_defendant_info as homeless
crim_homeless_casenums <- 
  crim_defendant_info_clean_2 %>%
  filter(Is_Homeless == T) %>%
  distinct(CaseNumber) %>%
  pull

# Working table 
wk1 <- crim_charge_and_disposition_info %>%
  # Pull only useful vars
  select(CaseNumber, Description, ChargeDescription, Disposition, PleaDate, DispositionDate) %>% # Split out the years and convert them to numeric
  # Split & filter by years
  separate(PleaDate, into = c("plea_year", "plea_month", "plea_day"), sep = "-", remove = F) %>%
  separate(DispositionDate, into = c("disposition_year", "disposition_month", "disposition_day"), sep = "-", remove = F) %>%
  filter(disposition_year >= 2014 | plea_year >= 2014) %>%
  mutate_if(is.character, tolower) %>%
  # Filter charge info by those who are homeless
  filter(CaseNumber %in% crim_homeless_casenums) %>%
  arrange(CaseNumber)

# Explore
wk1 %>%
  filter(str_detect(Description, "tres")) %>%
  # mutate(Description_Clean = case_when(
  # str_detect(Description, "(sex)(?=((.+)(4|(four))))") ~ "sex offense, 4th degree",
  #   str_detect(Description, "(sex)(?=((.+)(3|(thir))))") ~ "sex offense, 3rd degree",
  #   str_detect(Description, "((sex)|(rape))(?=((.+)(2|(sec))))") ~ "rape, 2nd degree",
  #   str_detect(Description, "((sex)|(rape))(?=((.+)(1|(firs))))") ~ "rape, 1st degree",
  #   str_detect(Description, "(sex)") ~ "sex offense, other",
  #   T ~ NA_character_
  # )) %>%
  group_by(Description) %>%
  # group_by(Description, Description_Clean) %>%
  summarize(n = n()) %>%
  arrange(desc(n))

# Clean charge info field
crim_defendant_info_clean_3 <-
  wk1 %>%
    #
  # group_by(Description) %>%
  # summarise(n = n()) %>%
  # filter(n > 10) %>%
  # arrange(Description) %>%
    #
  mutate(Description_Clean = case_when(
    str_detect(Description, "(ass)(?=(.+(first)|(1st)))") ~ "assault, 1st degree",
    str_detect(Description, "(ass)(?=(.+(sec)|(2nd)))") ~ "assault, 2nd degree",
    str_detect(Description, "(1st)(?=(.+(murder)))") ~ "attempted murder, 1st degree",
    str_detect(Description, "(burglary)(?=(.+((4)|(four))))") ~ "burglary, 4th degree",
    str_detect(Description, "(burglary)(?=(.+((3)|(third))))") ~ "burglary, 3rd degree",
    str_detect(Description, "(burglary)(?=(.+((2)|(sec))))") ~ "burglary, 2nd degree",
    str_detect(Description, "(burglary)(?=(.+((1)|(fir))))") ~ "burglary, 1st degree",
    str_detect(Description, "(cds)(?=(.+(dis)))") ~ "cds, (intent to) distribute",
    str_detect(Description, "(cds)(?=(.+(poss)))") ~ "cds, posession",
    str_detect(Description, "(theft)(?=(.+)((25((,000)|(k)))(.+)(100((,000)|(k)))))") ~ "theft, $25,000-$99,999",
    str_detect(Description, "(theft)(?=(.+)((1,500)(.+)(25((,000)|(k)))))") ~ "theft, $1,500-$24,999",
    str_detect(Description, "(theft)(?=(.+)((10((,000)|(k)))(.+)(100((,000)|(k)))))") ~ "theft, $10,000-$99,999",
    str_detect(Description, "(theft)(?=(.+)((1((,000)|(k)))(.+)(10((,000)|(k)))))") ~ "theft, $1,000-$9,999",
    str_detect(Description, "(theft)(?=(.+)((1((,000)|(k)))))") ~ "theft, less than $1,000",
    str_detect(Description, "(theft)(?=(.+)((100)(.+)(1,500)))") ~ "theft, $100-$1,499",
    str_detect(Description, "(theft)(?=(.+)((100(?!k))))") ~ "theft, less than $100",
    str_detect(Description, "(theft)") ~ "theft, other",
    str_detect(Description, "((deadly)|(dangerous))(?=(.*weapon))") ~ "dangerous weapon, conceal or possess",
    str_detect(Description, "(switch)") ~ "dangerous weapon, conceal or possess",
    str_detect(Description, "(handgun)") ~ "handgun, concceal or carry",
    str_detect(Description, "(reg)(?=(.+)(offender)) ") ~ "failure to register as offender",
    str_detect(Description, "(mal(.+)dest)(?!((.+)(less|under|below|<)))(?=(.+)(1,000))") ~ "destruction of property, malicious, at least $1,000",
    str_detect(Description, "(mal(.+)dest)(?=((.+)(less|under|below|<)))(?=(.+)(1,000))") ~ "destruction of property, malicious, less than $1,000",
    str_detect(Description, "(mal(.+)dest)(?=((.+)(prop)))") ~ "destruction of property, malicious, other",
    str_detect(Description, "(firearm)(?=((.+)poss))") ~ "firearm, illegal possession",
    str_detect(Description, "(poss)(?=((.+)firearm))") ~ "firearm, illegal possession",
    str_detect(Description, "(firearm)") ~ "firearm use",
    str_detect(Description, "(armed robbery)") ~ "robbery, armed",
    str_detect(Description, "(robbery)") ~ "robbery",
    str_detect(Description, "(traffic)") ~ "traffic violation",
    str_detect(Description, "(sex)(?=((.+)(4|(four))))") ~ "sex offense, 4th degree",
    str_detect(Description, "(sex)(?=((.+)(3|(thir))))") ~ "sex offense, 3rd degree",
    str_detect(Description, "((sex)|(rape))(?=((.+)(2|(sec))))") ~ "rape, 2nd degree",
    str_detect(Description, "((sex)|(rape))(?=((.+)(1|(firs))))") ~ "rape, 1st degree",
    str_detect(Description, "(sex)") ~ "sex offense, other",
    str_detect(Description, "(prob)") ~ "probation violation",
    str_detect(Description, "(tres)") ~ "trespassing, any",
    str_detect(Description, "(traff)") ~ "traffic violation",
    str_detect(Description, "(intox)(?=(.+)(endang))") ~ "reckless endangerment, intoxicated",
    str_detect(Description, "(endang)") ~ "reckless endangerment",
    T ~ Description
  )) %>%
  mutate(Crim_Code_Derived = case_when(
    Description_Clean == "assault, 1st degree" ~ "Section 3-202",
    Description_Clean == "assault, 2nd degree" ~ "Section 3-203",
    Description_Clean == "attempted murder, 1st degree" ~ "Section 2-205",
    Description_Clean == "burglary, 4th degree" ~ "Section 6-205",
    Description_Clean == "burglary, 3rd degree" ~ "Section 6-204",
    Description_Clean == "burglary, 2nd degree" ~ "Section 6-203",
    Description_Clean == "burglary, 1st degree" ~ "Section 6-202",
    Description_Clean == "cds, (intent to) distribute" ~ "Section 5-600",
    Description_Clean == "cds, posession" ~ "Section 5-600",
    str_detect(Description_Clean, "(theft)") ~ "Section 7-104",
    Description_Clean == "dangerous weapon, conceal or possess" ~ "Section 4-401",
    Description_Clean == "handgun, concceal or carry" ~ "Section 4-201",
    str_detect(Description_Clean, "(destruction of property)") ~ "Section 6-301",
    str_detect(Description_Clean, "(firearm)") ~ "Section 4-101",
    Description_Clean == "robbery" ~ "Section 3-402",
    Description_Clean == "robbery, armed" ~ "Section 3-403",
    Description_Clean == "sex offense, 4th degree" ~ "Section 3-308",
    str_detect(Description, "(sex)|(rape)") ~ "Section 3-301",
    str_detect(Description, "(prob)") ~ "Section 6-220",
    str_detect(Description, "(tress)") ~ "Section 6-401",
    T ~ NA_character_
  )) %>%
  mutate(Notes = case_when(
    Description_Clean == "assault, 1st degree" ~ "\"cause or attempt to cause serious physical injury\"",
    Description_Clean == "assault, 2nd degree" ~ "assault against police or first responders",
    Description_Clean == "attempted murder, 1st degree" ~ "\"attempted\" is distinct from successful",
    Description_Clean == "burglary, 4th degree" ~ "\"being in or on dwelling, storehouse, or environs ... with intent to commit theft\"",
    Description_Clean == "burglary, 3rd degree" ~ "\"break and enter the dwelling of another with the intent to commit a crime\"",
    Description_Clean == "burglary, 2nd degree" ~ "\"Breaking and entering with intent to commit theft, violence, or arson.\"",
    Description_Clean == "burglary, 1st degree" ~ "\"break and enter the dwelling of another with the intent to commit theft\"",
    Description_Clean == "dangerous weapon, conceal or possess" ~ "deadly / dangerous weapons are synonymous and include pepper spray and some knives but do not include handguns",
    Description_Clean == "handgun, concceal or carry" ~ "pistol, revolver, short-barreled shotgun, short-barreled rifle, \"or other firearm capable of being concealed on the person\"",
    str_detect(Description_Clean, "(robbery)") ~ "includes attempted and successful",
    Description_Clean == "sex offense, 4th degree" ~ "rape from a position of authority (e.g. teacher, coach, etc.), attempted or successful",
    Description_Clean == "sex offense, 3rd degree" ~ "rape, may include weapon, burglary, or kidnapping; attempted or successful",
    Description_Clean == "rape, 2nd degree" ~ "rape, attempted or successful",
    Description_Clean == "rape, 1st degree" ~ "rape forced with a weapon, attempted or successful",
    T ~ NA_character_
  ))


# Store the updated defendant info
# crim_defendant_info_clean_3 %>% write_csv(here("data", "input-data", "large-files", "criminal_baltimore_city_defendant_info.csv"))
rm(crim_defendant_info_clean_2, wk1)

```

```{r}

## Can run this instead of re-cleaning work above

crim_defendant_info_clean_3 <- read_csv(here("data", "input-data", "large-files", "criminal_baltimore_city_defendant_info.csv"), col_types = c("Sex" = "f", "Race"="f", "Name"="c", "Institution_Type"="f"))

glimpse(crim_defendant_info_clean_2)

```

```{r}

crim_defendant_info_clean_3 %>%
  group_by(Description_Clean) %>%
  summarize(n = n()) %>%
  #filter(n > 10) %>%
  arrange(desc(n))

```

## Civil Case Exploration

```{r}

civil_case_info %>%
  group_by(CaseType) %>%
  summarize(n = n()) %>%
  arrange(desc(n))

# Clean up addresses
civil_defendant_info_clean <- civil_defendant_info %>%
  mutate_if(is.character, tolower) %>%
  # Standardize cardinal directions
  mutate(Address = str_replace_all(Address, "\\se(\\s|\\.)", " east ")) %>% # "e" or "e." becomes "east"
  mutate(Address = str_replace_all(Address, "\\sw(\\s|\\.)", " west ")) %>%
  mutate(Address = str_replace_all(Address, "\\sn(\\s|\\.)", " north ")) %>%
  mutate(Address = str_replace_all(Address, "\\ss(\\s|\\.)", " south ")) %>%
  # Standardize street type suffixes
  mutate(Address = str_replace_all(Address, "\\s(street|st\\.)(\\s|$)", " st")) %>% # "street" or "st." becomes "st"
  mutate(Address = str_replace_all(Address, "\\s(avenue|ave\\.)(\\s|$)", " ave ")) %>%
  mutate(Address = str_replace_all(Address, "\\s(road|rd\\.)(\\s|$)", " rd ")) %>%
  mutate(Address = str_replace_all(Address, "\\s(highway|hwy\\.)(\\s|$)", " hwy ")) %>%
  mutate(Address = str_replace_all(Address, "\\s(boulevard|blvd\\.)(\\s|$)", " bldv ")) %>%
  # Standardize PO boxes. 
  mutate(Address = str_replace_all(Address, "(\\s|^|/)((po)|(p\\so)|(p\\.o)|(po\\.))((\\s(box))|(\\s(bx)))", " p.o. box")) %>% # "po | p o | p.o | po." followed by "box" or "bx" become "p.o. box"
  mutate(Address = str_replace_all(Address, "\\s(box)-", " box ")) %>% # Removes hyphens from PO boxes, e.g. "box-xxxx" becomes "box xxxx"
  mutate(Address = str_replace_all(Address, "id#\\s\\d+", " ")) %>% # Remove ID#s from addresses, such as from prison P.O. boxes
  # Remove any white space inadvertantly added
  mutate(Address = str_trim(Address)) %>%
  # Convert addresses to institution locations
  mutate(Institution = case_when(
    # Each case below was manually checked and adjusted for variations in source data
    str_detect(Address, "(box)\\s((549)|(534))") ~ "jessup correctional institution",
    str_detect(Address, "(401 east eager)|(baltimore city detention center)") ~ "baltimore city detention center",
    str_detect(Address, "620 fallsway") ~ "weinberg housing and resource center",
    str_detect(Address, "(1029 east baltimore)|((?<!p)((help)|(helping) (us|up|out) mission))") ~ "helping up mission", # not preceded by "p" to avoid falsely matching "phelps"
    str_detect(Address, "(3643 woodland)|(gaudenzia inc)|(c/o gaudenzia)") ~ "gaudenzia inc weinberg center",
    str_detect(Address, "^4 north central") ~ "baltimore rescue mission",
    str_detect(Address, "210 guilford") ~ "baltimore city health department",
    str_detect(Address, "954 fo(r|rr)est") ~ "metropolitan transition center",
    str_detect(Address, "((18\\d+ (ro(x|xs)bu(r|rr)(y|g)))|(roxbur(y|g) corr))|(roxbur$)|(roxburury)") ~ "roxbury correctional institution",
    str_detect(Address, "(300 east madison)|(central booking intake)") ~ "baltimore central booking and intake center",
    str_detect(Address, "(725 fallsway)|(bread)") ~ "our daily bread employment center",
    str_detect(Address, "^140 west west") ~ "the baltimore station veterans rehab",
    str_detect(Address, "(wci)|(13800 mcmullen)|(western correctional)") ~ "western correctional institution",
    str_detect(Address, "(^111 park)|(healthcare)") ~ "health care for the homeless",
    str_detect(Address, "(?<!((for )|(the )))(homeless)") ~ "marked \"homeless\"", # not preceded by "for" or "the" to avoid labeling "health care (for / for the) homeless"
    T ~ NA_character_
  )) %>%
  # Add column to designate type of institution
  mutate(Institution_Type = case_when(
    str_detect(Institution, "(detention)|(correction)|(booking)") ~ "corrections",
    !is.na(Institution) ~ "homeless resource (unspecified)",
    T ~ NA_character_
  )) %>%
  left_join(homeless_resources %>% 
              # Keep only unique addresses to prevent muliple match duplication in the join
              distinct(Address, .keep_all = TRUE), 
            by = c("Address")
            ) %>%
  # Transpose Institution_Type values from homeless resources list
  mutate(Institution = ifelse(!is.na(Institution.y), Institution.y, Institution.x)) %>%
  mutate(Institution_Type = ifelse(!is.na(Institution_Type.y), Institution_Type.y, Institution_Type.x)) %>%
  # Drop redundant col and rename remaining
  select(-matches("\\.x$|\\.y$")) %>%
  mutate(Is_Homeless = ifelse((!is.na(Institution_Type) & Institution_Type != "corrections"), T, F))

# View grouped address counts for known homeless
civil_defendant_info_clean %>%
  filter(Is_Homeless == T) %>%
  group_by(Address) %>%
  summarize(n = n()) %>%
  left_join(homeless_resources %>% select(Address, Institution)) %>%
  arrange(desc(n))

# Pull list of cases related to homeless people
civil_homeless_casenums <- civil_defendant_info_clean %>%
  filter(Is_Homeless == T) %>%
  distinct(CaseNumber) %>%
  pull

civil_defendant_info_clean %>%
  filter(CaseNumber %in% civil_homeless_casenums) %>%
  select(CaseNumber, Address) %>%
  arrange(CaseNumber)

# Combine with civil case information

civil_case_info %>%
  mutate_if(is.character, tolower) %>%
  filter(CaseNumber %in% civil_homeless_casenums) %>%
  group_by(CaseType) %>%
  summarize(n = n()) %>%
  arrange(desc(n))

```

### Notes for continued work

FARE DODGING is a civil infraction as of 2018. Before that it was criminal. Md. Transportation Code Section 7-705 enumerates requirement to pay applicable fares. I cannot find it in either civil or criminal cases.

Trespassing is both a criminal charge and a civil torte in Md.

* CHECK DATA for UNKs that should be DEFs
* CALL state's attorney contact Brad gave me to ask about [email sent Oct. 31] [voicemail left Nov. 5]
  * addresses: UNK, correctional facilities
  * fare dodging charge -- can't find any in criminal or civil
  * civil habeas corpus charges; what does this mean and why so many homeless?


* Laws against homelessness
    * Cross reference people identified as homeless from today's work with charge_info to find what people are frequently charged with
    * look at charges commonly associated with homelessness (loitering, sleeping in public, begging, etc.)
* Further `Address == UNKNOWN` work
    * How many `Address == UNKNOWN`s might indicate homelessness?
    * How many `Address == UNKNOWN`s are ALIASes that were coded "UNKNOWN" instead of "DEF?" [DO THIS SOON]


* FARE DODGING -- where are the charges?
* HABEUS CORPUS -- what are all these?
* UNKNOWNs -- are these homeless people?
* CORRECTIONS -- current v former address?
* LEAD PAINT -- these are against the orgs themselves, right?





































